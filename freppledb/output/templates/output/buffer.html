{% extends "admin/base_site_gridpivot.html" %}
{% load i18n %}

{% block tools %}{% if active_tab == "inventory" %}{% tabs "input.item" %}{% elif args.0 %}{% tabs "input.buffer" %}{% endif %}{{block.super}}{% endblock %}

{% block before_table %}{% if args.0 %}
<div id="graph" style="clear: both; height: 400px; padding: 10px; "></div>
{% endif %}{% endblock %}

{% block crosses %}
{% if args.0 %}$(function(){
  // Resize top graph
  var h = $(window).height();
  $("#graph").width($(window).width()-60).height(h>1000 || h<680 ? 360 : h-620);
});{% endif %}

{% if args.0 or mode == "graph" %}
function drawGraphs(jsondata)
{
  $('#curerror').html("");
  {% if args.0 %}var margin = {top: 0, right: 100, bottom: 30, left: 70};
  {% else %}var margin = {top: 0, right: 0, bottom: 0, left: 70};
  {% endif %}var width = $({% if args.0 %}"#graph"{% else %}"#grid_graph"{% endif %}).width() - margin.left - margin.right;
  var height = {% if args.0 %}$("#graph").height(){% else %}80{% endif %} - margin.top - margin.bottom;
  
  // Lookup table of displayed columns
  var fields = new Set();
  // dict that gives from an id the name of the cross
  var field_by_id = {};
  // dict that gives from the name of a cross the id
  var id_by_field = {};
  for (var i in cross_idx) {
    fields.add(cross[cross_idx[i]]["key"]);
    field_by_id[cross_idx[i]] = cross[cross_idx[i]]["key"];
    id_by_field[cross[cross_idx[i]]["key"]] = cross_idx[i];
  }
 
  // Define X-axis
  var domain_x = [];
  var bucketnamelength = 0;
  for (var i in timebuckets)
  {
    domain_x.push(timebuckets[i]['name']);
    bucketnamelength = Math.max(timebuckets[i]['name'].length, bucketnamelength);
  }
  var x = d3.scale.ordinal()
    .domain(domain_x)
    .rangeRoundBands([0, width], .1);
  var x_width = x.rangeBand();
  {% if mode == "graph" and not args.0 %}graph.header(margin.left, x);{% endif %}
  
  // Define Y-axis
  var y = d3.scale.linear().rangeRound([height, 0]);

  // Draw all graphs
  $("#grid"){% if not args.0 %}.find(".graph"){% endif %}.each(function(index)
  {
    // Create a new SVG element
    $({% if args.0 %}$("#graph").get(0){% else %}this{% endif %}).html("");
    var svg = d3.select({% if args.0 %}$("#graph").get(0){% else %}this{% endif %})
      .append("svg")
      .attr("class","graphcell")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Build the data for d3
    var max_y = 0;
    var min_y = 0;
    var data = [];
    for (var bckt in timebuckets)
    {
      var tmp = jsondata['rows'][index][timebuckets[bckt]['name']];
      data.push({
	        'buffer': jsondata['rows'][index]['buffer'],
	        'bucket': bckt,
	        'startinv': tmp[id_by_field['startoh']],
	        'startohdoc': tmp[id_by_field['startohdoc']],
	        'safetystock': tmp[id_by_field['safetystock']],    
	        'consumed': tmp[id_by_field['consumed']],
	        'consumedMO': tmp[id_by_field['consumedMO']],
	        'consumedDO': tmp[id_by_field['consumedDO']],
	        'consumedSO': tmp[id_by_field['consumedSO']],
	        'consumedFcst': tmp[id_by_field['consumedFcst']],
	        'produced': tmp[id_by_field['produced']],
	        'producedMO': tmp[id_by_field['producedMO']],
	        'producedDO': tmp[id_by_field['producedDO']],
	        'producedPO': tmp[id_by_field['producedPO']],
	        'endinv': tmp[id_by_field['endoh']],
	        'total_in_progress': tmp[id_by_field['total_in_progress']],
	        'work_in_progress_mo': tmp[id_by_field['work_in_progress_mo']],
	        'on_order_po': tmp[id_by_field['on_order_po']],
	        'in_transit_do': tmp[id_by_field['in_transit_do']]
	        });
      for (var i in cross_idx)
      {
        var t = field_by_id[cross_idx[i]];
        if (t == 'startoh' 
            || t == 'safetystock' 
            || t == 'consumed' 
            || t == 'produced' 
            || t == 'endoh') {
          if (tmp[cross_idx[i]] < min_y) min_y = tmp[cross_idx[i]];
          if (tmp[cross_idx[i]] > max_y) max_y = tmp[cross_idx[i]];
          }
      }
    }

    // Update the scale of the Y-axis by looking for the max value
    y.domain([min_y,max_y]);
    var y_zero = y(0);

    // Create D3 bars
    var my_y;
    svg.selectAll("g")
      .data(data)
      .enter()
      .append("g")
      .attr("transform", function(d) { return "translate(" + x(timebuckets[d['bucket']]['name']) + ",0)"; })
      .each(function(d) {
        var bucket = d3.select(this);
        if (d['produced'] > 0 && fields.has('produced'))
        {
          my_y = y(d['produced']);
          bucket.append("rect")
            .attr("width", x_width/2)
            .attr("height", y_zero - my_y)
            .attr("x", x_width/2)
            .attr("y", my_y)
            .style("fill","#2B95EC");
        }
        if (d['consumed'] > 0 && fields.has('consumed'))
        {
          my_y = y(d['consumed']);
          bucket.append("rect")
            .attr("width", x_width/2)
            .attr("height", y_zero - my_y)
            .attr("y", my_y)
            .style("fill","#F6BD0F");
        }
        // Invisible rectangle for the tooltip
      	bucket.append("rect")
	      .attr("height", height)
	      .attr("width", x_width)
	      .attr("fill-opacity", 0)
	      .on("click", function(d) {
	          if (d3.event.defaultPrevented || (d['produced'] == 0 && d['consumed'] == 0))
	            return;
	          d3.select("#tooltip").style('display', 'none');
	
	          window.location = url_prefix
	            + "/data/input/operationplanmaterial/buffer/"
	            + admin_escape(d['buffer'])
	            + "/?noautofilter&flowdate__gte=" + timebuckets[d['bucket']]['startdate']
	            + "&flowdate__lt=" + timebuckets[d['bucket']]['enddate'];
	
	          d3.event.stopPropagation();
	        })
	      .on("mouseenter", function(d) {
	        tiptext = '<div class="panel-heading" style="text-align:center; font-weight:bold">'
	          + timebuckets[d['bucket']]['name'] + '</div>'
	          + '<table><tr><td>{{_('start inventory days of cover')|capfirst}}</td><td style="text-align:right">'
	          + d['startohdoc'] + " {{_('days')}}"
	          + '</td></tr><tr><td>{{_('start inventory')|capfirst}}</td><td style="text-align:right">'
	          + grid.formatNumber(d['startinv']);
	        if (d['producedPO'])
	          tiptext += '</td></tr><tr><td>{{_('produced by PO')|capfirst}}</td><td style="text-align:right">+ '
	            + grid.formatNumber(d['producedPO']);
	        if (d['producedMO'])
	          tiptext += '</td></tr><tr><td>{{_('produced by MO')|capfirst}}</td><td style="text-align:right">+ '
	            + grid.formatNumber(d['producedMO']);
	        if (d['producedDO'])
	          tiptext += '</td></tr><tr><td>{{_('produced by DO')|capfirst}}</td><td style="text-align:right">+ '
	            + grid.formatNumber(d['producedDO']);
	        if (d['consumedMO'])
	          tiptext += '</td></tr><tr><td>{{_('consumed by MO')|capfirst}}</td><td style="text-align:right">- '
	            + grid.formatNumber(d['consumedMO']);
	        if (d['consumedSO'])
	          tiptext += '</td></tr><tr><td>{{_('consumed by SO')|capfirst}}</td><td style="text-align:right">- '
	            + grid.formatNumber(d['consumedSO']);
	        if (d['consumedFcst'])
	          tiptext += '</td></tr><tr><td>{{_('consumed by Fcst')|capfirst}}</td><td style="text-align:right">- '
	            + grid.formatNumber(d['consumedFcst']);
	        if (d['consumedDO'])
	          tiptext += '</td></tr><tr><td>{{_('consumed by DO')|capfirst}}</td><td style="text-align:right">- '
	            + grid.formatNumber(d['consumedDO']);
	        tiptext += '</td></tr><tr><td>{{_('end inventory')|capfirst}}</td><td style="text-align:right">= '
	          + grid.formatNumber(d['startinv']+d['produced']-d['consumed']);
	        if (d['safetystock'])
	          tiptext += '</td></tr><tr><td>{{_('safety stock')|capfirst}}</td><td style="text-align:right">'
	            + grid.formatNumber(d['safetystock']);
	        if (d['total_in_progress'])
	          tiptext += '</td></tr><tr><td>{{_('total in progress')|capfirst}}</td><td style="text-align:right">'
	            + grid.formatNumber(d['total_in_progress']);
	        if (d['work_in_progress_mo'])
	          tiptext += '</td></tr><tr><td>{{_('work in progress MO')|capfirst}}</td><td style="text-align:right">'
	            + grid.formatNumber(d['work_in_progress_mo']);
	        if (d['on_order_po'])
	          tiptext += '</td></tr><tr><td>{{_('on order PO')|capfirst}}</td><td style="text-align:right">'
	            + grid.formatNumber(d['on_order_po']);
	        if (d['in_transit_do'])
	          tiptext += '</td></tr><tr><td>{{_('in transit DO')|capfirst}}</td><td style="text-align:right">'
	            + grid.formatNumber(d['in_transit_do']);
	        tiptext += '</td></tr></table>'          
	        graph.showTooltip(tiptext);
	        })
	      .on("mouseleave", graph.hideTooltip)
	      .on("mousemove", graph.moveTooltip);        
      });

    // Create D3 line
    if (fields.has('startoh'))
    {
      var line = d3.svg.line()
        .x(function(d) { return x(timebuckets[d['bucket']]['name']) + x_width / 2; })
        .y(function(d) { return y(d['startinv']); });
      svg.append("svg:path")
        .attr('class', 'graphline')
        .attr("stroke","#8BBA00")
        .attr("d", line(data));
    }
    else if (fields.has('endoh'))
    {
      var line = d3.svg.line()
        .x(function(d) { return x(timebuckets[d['bucket']]['name']) + x_width / 2; })
        .y(function(d) { return y(d['endinv']); });
      svg.append("svg:path")
        .attr('class', 'graphline')
        .attr("stroke","#7B5E08")
        .attr("d", line(data));
    }
    if (fields.has('safetystock'))
    {
      var line = d3.svg.line()
        .x(function(d) { return x(timebuckets[d['bucket']]['name']) + x_width / 2; })
        .y(function(d) { return y(d['safetystock']); });
      svg.append("svg:path")
        .attr('class', 'graphline')
        .attr("stroke","#FF0000")
        .attr("d", line(data));
    }

    // Display Y-Axis
    var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");
    {% if not args.0 %}
    svg.append("g")
      .attr("class", "miniaxis")
      .call(graph.miniAxis.bind(yAxis));
    {% else %}
    svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);

    // Display 0 line
    if (min_y < 0 && max_y > 0)
      svg.append("line")
        .attr("x1", 0)
        .attr("x2", width)
        .attr("y1", y(0))
        .attr("y2", y(0))
        .attr("stroke-width", 1)
        .attr("stroke", "black")
        .attr("shape-rendering", "crispEdges");

    // Display X-axis for a single buffer
    var nth = Math.ceil(timebuckets.length / width * bucketnamelength * 10);
    var myticks = [];
    for (var i in timebuckets)
      if (i % nth == 0) myticks.push(timebuckets[i]['name']);
    var xAxis = d3.svg.axis()
      .scale(x)
      .tickValues(myticks)
      .orient("bottom");
    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

    // Display legend
    var legend = svg.append("g");
    var codes = [
      ['{{_('start inventory')|capfirst}}', "#8BBA00"],
      [],
      ['{{_('safety stock')|capfirst}}', "#FF0000"],
      ['{{_('consumed')|capfirst}}', "#F6BD0F"],
      [],
      [],
      [],
      ['{{_('produced')|capfirst}}', "#2B95EC"],
      [],
      [],
      [],
      ['{{_('end inventory')|capfirst}}', "#7B5E08"]
      ];
    var cnt = 0;
    for (var i in cross_idx)
    {
      if (field_by_id[cross_idx[i]] == 'startoh' 
            || field_by_id[cross_idx[i]] == 'safetystock' 
            || field_by_id[cross_idx[i]] == 'consumed' 
            || field_by_id[cross_idx[i]] == 'produced' 
            || field_by_id[cross_idx[i]] == 'endoh') {
        legend.append("rect")
          .attr("x", width + 82)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", codes[cross_idx[i]][1])
          .attr("transform", "translate(0," + (cnt*20+10) + ")");
        legend.append("text")
          .attr("x", width + 76)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style("text-anchor", "end")
          .text(codes[cross_idx[i]][0])
          .attr("transform", "translate(0," + (cnt*20+10) + ")");
        ++cnt;
        }
    }{% endif %}
    });
}
{% endif %}
{% if args.0 or mode == "table" %}
function crosses (cellvalue, options, rowdata)
{
  var result = '';
  
  // dict that gives from an id the name of the cross
  var field_by_id = {};
  // dict that gives from the name of a cross the id
  var id_by_field = {};
  for (var i in cross_idx) {
    field_by_id[cross_idx[i]] = cross[cross_idx[i]]["key"];
    id_by_field[cross[cross_idx[i]]["key"]] = cross_idx[i];
  }
  
  for (var i in cross_idx)
    switch(field_by_id[cross_idx[i]])
    {
      case 'startohdoc':
        result += cellvalue[cross_idx[i]] + '<br>';
        break;
      case 'consumed':
        if (cellvalue[id_by_field['consumed']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['consumed']]) + "<a href='{{request.prefix}}/data/input/operationplanmaterial/buffer/" +
              admin_escape(rowdata['buffer']) +
              "/?flowdate__gte=" + options['colModel']['startdate'] +
              "&amp;flowdate__lt=" + options['colModel']['enddate'] +
              "&amp;quantity__lt=0&amp;noautofilter'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'consumedMO':
        if (cellvalue[id_by_field['consumedMO']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['consumedMO']]) + "<a href='{{request.prefix}}/data/input/manufacturingorder/consumed/" +
              admin_escape(rowdata['item']) + "/" +
              admin_escape(rowdata['location']) + "/" +
              options['colModel']['startdate'] + "/" +
              options['colModel']['enddate'] + "/" +
              "?noautofilter" +  
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'consumedDO':
        if (cellvalue[id_by_field['consumedDO']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['consumedDO']]) + "<a href='{{request.prefix}}/data/input/distributionorder/consumed/" +
              admin_escape(rowdata['item']) + "/" +
              admin_escape(rowdata['location']) + "/" +
              options['colModel']['startdate'] + "/" +
              options['colModel']['enddate'] + "/" +
              "?noautofilter" +
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'consumedSO':
        if (cellvalue[id_by_field['consumedSO']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['consumedSO']]) + "<a href='{{request.prefix}}/data/input/deliveryorder/consumed/" +
              admin_escape(rowdata['item']) + "/" +
              admin_escape(rowdata['location']) + "/" +
              options['colModel']['startdate'] + "/" +
              options['colModel']['enddate'] + "/" +
              "?noautofilter" + 
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "&amp;orders=True" +"'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'consumedFcst':
        if (cellvalue[id_by_field['consumedFcst']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['consumedFcst']]) + "<a href='{{request.prefix}}/data/input/deliveryorder/consumed/" +
              admin_escape(rowdata['item']) + "/" +
              admin_escape(rowdata['location']) + "/" +
              options['colModel']['startdate'] + "/" +
              options['colModel']['enddate'] + "/" +
              "?noautofilter" + 
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "&amp;orders=False" +"'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'produced':
        if (cellvalue[id_by_field['produced']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['produced']]) + "<a href='{{request.prefix}}/data/input/operationplanmaterial/buffer/" +
              admin_escape(rowdata['buffer']) +
              "/?flowdate__gte=" + options['colModel']['startdate'] +
              "&amp;flowdate__lt=" + options['colModel']['enddate'] +
              "&amp;quantity__gte=0&amp;noautofilter'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'producedMO':
        if (cellvalue[id_by_field['producedMO']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['producedMO']]) + "<a href='{{request.prefix}}/data/input/manufacturingorder/produced/" +
              admin_escape(rowdata['item']) + "/" +
              admin_escape(rowdata['location']) + "/" +
              options['colModel']['startdate'] + "/" +
              options['colModel']['enddate'] + "/" +
              "?noautofilter" +
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'producedDO':
        if (cellvalue[id_by_field['producedDO']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['producedDO']]) + "<a href='{{request.prefix}}/data/input/distributionorder/produced/" +
              admin_escape(rowdata['item']) + "/" +
              admin_escape(rowdata['location']) + "/" +
              options['colModel']['startdate'] + "/" +
              options['colModel']['enddate'] + "/" +
              "?noautofilter" +
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'producedPO':
        if (cellvalue[id_by_field['producedPO']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['producedPO']]) + "<a href='{{request.prefix}}/data/input/purchaseorder/produced/" +
              admin_escape(rowdata['item']) + "/" +
              admin_escape(rowdata['location']) + "/" +
              options['colModel']['startdate'] + "/" +
              options['colModel']['enddate'] + "/" +
              "?noautofilter" +
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'work_in_progress_mo':
        if (cellvalue[id_by_field['work_in_progress_mo']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['work_in_progress_mo']]) + "<a href='{{request.prefix}}/data/input/manufacturingorder/operationplanmaterial/" +
              admin_escape(rowdata['item']) + "/" + admin_escape(rowdata['location']) +
              "/" + options['colModel']['enddate'] +
              "/?noautofilter" +
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'on_order_po':
        if (cellvalue[id_by_field['on_order_po']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['on_order_po']]) + "<a href='{{request.prefix}}/data/input/purchaseorder/operationplanmaterial/" +
              admin_escape(rowdata['item']) + "/" + admin_escape(rowdata['location']) +
              "/" + options['colModel']['enddate'] +
              "/?noautofilter" +
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      case 'in_transit_do':
        if (cellvalue[id_by_field['in_transit_do']] != 0.0)
           result += grid.formatNumber(cellvalue[id_by_field['in_transit_do']]) + "<a href='{{request.prefix}}/data/input/distributionorder/operationplanmaterial/" +
              admin_escape(rowdata['item']) + "/" + admin_escape(rowdata['location']) +
              "/" + options['colModel']['enddate'] +
              "/?noautofilter" +
              (rowdata['batch'] == undefined || rowdata['batch'] == ""? "":"&batch=" + admin_escape(rowdata['batch'])) +
              "'>&nbsp;<span class='context cross fa fa-caret-right'></span></a><br>";
        else
          result += '0<br>';
        break;
      default:
        result += grid.formatNumber(cellvalue[cross_idx[i]]) + '<br>';
    }
  return result;
};
{% endif %}{% endblock %}

{% block extra_grid %}{% if args.0 or mode == "graph" %}loadComplete: drawGraphs,
{% endif %}{% endblock %}

