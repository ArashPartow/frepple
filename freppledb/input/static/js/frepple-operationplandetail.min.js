/* frePPLe 4.0.0
Copyright (C) 2010-2019 by frePPLe bv

This library is free software; you can redistribute it and/or modify it
under the terms of the GNU Affero General Public License as published
by the Free Software Foundation; either version 3 of the License, or
(at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

angular.module("calendar",[]).constant("calendarConfig",{formatDay:"d",formatDayHeader:"EEE",formatDayTitle:"MMMM dd, yyyy",formatWeekTitle:"MMMM yyyy, Week w",formatMonthTitle:"MMMM yyyy",formatWeekViewDayHeader:"EEE d",formatHourColumn:"ha",showWeeks:!0}).controller("calendarController",["$scope","$attrs","$parse","$interpolate","$log","dateFilter","gettextCatalog","calendarConfig","PreferenceSvc",function(e,t,a,n,r,o,i,l,d){"use strict";var s=this,p={$setViewValue:angular.noop};angular.forEach(["formatDay","formatDayHeader","formatDayTitle","formatWeekTitle","formatMonthTitle","formatWeekViewDayHeader","formatHourColumn"],function(a,r){s[a]=angular.isDefined(t[a])?n(t[a])(e.$parent):l[a]}),angular.forEach(["showWeeks"],function(a,n){s[a]=angular.isDefined(t[a])?e.$parent.$eval(t[a]):l[a]}),s.hourParts=3600;var u=e.$parent.$watch(t.eventSource,function(e){s.onEventSourceChanged(e)});e.$on("$destroy",u),e.admin_escape=admin_escape,e.url_prefix=url_prefix,e.scrollBarWidth=getScrollBarWidth(),e.calendarmode=calendarmode,e.grouping=grouping,e.groupingdir=groupingdir,e.grid=grid,e.groupingcfg=groupingcfg,e.calendarmodes={start:i.getString("View start events"),end:i.getString("View end events"),start_end:i.getString("View start and end events"),duration:i.getString("View full duration")},e.setCalendarMode=function(t){e.calendarmode=t,d.save("calendarmode",t)},e.setGrouping=function(t){e.grouping=t,d.save("grouping",t),s._onDataLoaded()},e.setGroupingDir=function(t){e.groupingdir=t,d.save("groupingdir",t),s._onDataLoaded()},angular.isDefined(t.initDate)&&(s.currentCalendarDate=e.$parent.$eval(t.initDate)),s.currentCalendarDate||(s.currentCalendarDate=new Date,t.ngModel&&!e.$parent.$eval(t.ngModel)&&a(t.ngModel).assign(e.$parent,s.currentCalendarDate)),e.getHeight=function(e){return preferences&&preferences.height?preferences.height-e:220-e},e.displayEvent=function(t,a){switch(e.calendarmode){case"duration":return!0;case"start_end":return moment(t.startdate||t.event.startdate||t.enddate||t.event.enddate).isSame(a.date,"day")||moment(t.enddate||t.event.enddate||t.startdate||t.event.startdate).isSame(a.date,"day");case"start":return moment(t.startdate||t.event.startdate||t.enddate||t.event.enddate).isSame(a.date,"day");case"end":return moment(t.enddate||t.event.enddate||t.startdate||t.event.startdate).isSame(a.date,"day")}},e.isStart=function(e,t){var a=e.startdate||e.event&&e.event.startdate;return!!a&&moment(a).isSame(t.date,"day")},e.isEnd=function(e,t){var a=e.enddate||e.event&&e.event.enddate;return!!a&&moment(a-1).isSame(t.date,"day")},e.displayEvent=function(t,a){switch(e.calendarmode){case"duration":return!0;case"start_end":return!!(t.startdate||t.event&&t.event.startdate)&&moment(t.startdate||t.event&&t.event.startdate).isSame(a.date,"day")||!!(t.enddate||t.event&&t.event.enddate)&&moment((t.enddate||t.event&&t.event.enddate)-1).isSame(a.date,"day");case"start":return!!(t.startdate||t.event&&t.event.startdate)&&moment(t.startdate||t.event&&t.event.startdate).isSame(a.date,"day");case"end":return!!(t.enddate||t.event&&t.event.enddate)&&moment((t.enddate||t.event&&t.event.enddate)-1).isSame(a.date,"day")}},s.init=function(e){(p=e).$render=function(){s.render()}},s.render=function(){if(p.$modelValue){var e=new Date(p.$modelValue),t=!isNaN(e);t?this.currentCalendarDate=e:r.error('"ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),p.$setValidity("date",t)}this.refreshView()},s.refreshView=function(){this.mode&&(this.range=this._getRange(this.currentCalendarDate),this._refreshView(),this.rangeChanged())},s.split=function(e,t){for(var a=[];e.length>0;)a.push(e.splice(0,t));return a},s.onEventSourceChanged=function(e){s.eventSource=e,s._onDataLoaded&&s._onDataLoaded()},e.move=function(t){var a,n=s.mode.step,r=s.currentCalendarDate,o=r.getFullYear()+t*(n.years||0),i=r.getMonth()+t*(n.months||0),l=r.getDate()+t*(n.days||0);r.setFullYear(o,i,l),"calendarmonth"===e.mode&&(a=new Date(o,i+1,1)).getTime()<=r.getTime()&&(s.currentCalendarDate=new Date(a-864e5)),p.$setViewValue(s.currentCalendarDate),s.refreshView()},s.move=function(t){e.move(t)},s.changeMode=function(t){e.mode=t},s.rangeChanged=function(){e.rangeChanged?e.rangeChanged({startdate:this.range.startdate,enddate:this.range.enddate}):console.error("No rangeChanged callback is registered")},s.placeEvents=function(e){!function(e){var t,a,n,r,o,i,l,d=e.length,p=0,u=new Array(d);for(t=0;t<d;t+=1){for(n=0;n<p;n+=1)u[n]=!1;for(a=0;a<t;a+=1)r=e[t],o=e[a],i=void 0,l=void 0,i=r,l=o,(r.startIndex>o.startIndex||r.startIndex===o.startIndex&&r.startOffset>o.startOffset)&&(i=o,l=r),i.endIndex<=l.startIndex||i.endIndex-l.startIndex==1&&i.endOffset+l.startOffset>=s.hourParts||(u[e[a].position]=!0);for(n=0;n<p&&u[n];n+=1);e[t].position=n<p?n:p++}}(e),function(e,t){var a,n,r,o,i,l,d,s=24*t,p=new Array(s);for(e.sort(function(e,t){return t.position-e.position}),r=0;r<s;r+=1)p[r]={calculated:!1,events:[]};for(i=e.length,r=0;r<i;r+=1)for(n=(a=e[r]).startIndex*t+a.startOffset;n<a.endIndex*t-a.endOffset;)p[n].events.push(a),n+=1;for(r=0;r<i;){if(!(a=e[r]).overlapNumber){var u=a.position+1;a.overlapNumber=u;for(var c=[a];a=c.shift();)for(n=a.startIndex*t+a.startOffset;n<a.endIndex*t-a.endOffset;){if(!p[n].calculated&&(p[n].calculated=!0,p[n].events))for(l=p[n].events.length,o=0;o<l;o+=1)(d=p[n].events[o]).overlapNumber||(d.overlapNumber=u,c.push(d));n+=1}}r+=1}}(e,s.hourParts)}}]).directive("calendar",function(){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/calendar.html",scope:{mode:"=",editable:"=",rangeChanged:"&",eventSelected:"&",timeSelected:"&"},require:["calendar","?^ngModel"],controller:"calendarController",link:function(e,t,a,n){var r=n[0],o=n[1];e.curselected=null,o&&r.init(o),e.$on("selectedEdited",function(t,a,n,r){null!==e.curselected&&(e.changeCard(e.curselected,a,n),e.curselected[a]=r)}),e.$on("changeDate",function(e,t){r.move(t)}),e.$on("eventSourceChanged",function(e,t){r.onEventSourceChanged(t)}),e.$on("changeMode",function(e,t){r.changeMode(t)}),e.selectCard=function(t){if(e.curselected){if(e.curselected.reference==t.reference&&t.selected)return;delete e.curselected.selected}t.selected=!0,e.curselected=t,e.eventSelected({event:t})},e.changeCard=function(t,a,n,r){t.hasOwnProperty(a+"Original")||(t[a+"Original"]=n),t.dirty=!0,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),void 0!==r&&e.$parent.$broadcast("cardChanged",a,n,r)}}}}).directive("monthview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/month.html",require:["^calendar","?^ngModel"],link:function(t,a,n,r){var o=r[0],i=r[1];function l(t,a){return{date:t,label:e(t,a),selected:0===o.compare(t,o.currentCalendarDate),current:0===o.compare(t,new Date)}}function d(e,t){return(e.startdate?e.startdate:e.enddate).getTime()-(t.startdate?t.startdate:t.enddate)}function s(e){var t=new Date(e.getFullYear(),0,1).getDay(),a=new Date(e.getFullYear(),0,(t<=4?5:12)-t),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+(4-e.getDay()))-a;return 1+Math.round(n/6048e5)}t.showWeeks=o.showWeeks,o.mode={step:{months:1}},t.select=function(e){var a=t.rows,n=e.date,r=e.events;if(a){var l=o.currentCalendarDate,d=l.getMonth(),s=l.getFullYear(),p=n.getMonth(),u=n.getFullYear(),c=0;if(s===u?d!==p&&(c=d<p?1:-1):c=s<u?1:-1,o.currentCalendarDate=n,i&&i.$setViewValue(n),0===c)for(var f=0;f<6;f+=1)for(var m=0;m<7;m+=1){var g=0===o.compare(n,a[f][m].date);a[f][m].selected=g,g&&(t.selectedDate=a[f][m])}else o.refreshView();t.timeSelected&&t.timeSelected({selectedTime:n,events:r})}},o._refreshView=function(){for(var a=o.range.startdate,n=a.getDate(),r=(a.getMonth()+(1!==n?1:0))%12,i=a.getFullYear()+(1!==n&&0===r?1:0),d=function(e,t){var a=new Array(t),n=new Date(e),r=0;for(n.setHours(12);r<t;)a[r++]=new Date(n),n.setDate(n.getDate()+1);return a}(a,42),p=0;p<42;p++)d[p]=angular.extend(l(d[p],o.formatDay),{secondary:d[p].getMonth()!==r});t.labels=new Array(7);for(var u=0;u<7;u++)t.labels[u]=e(d[u].date,o.formatDayHeader);var c=new Date(i,r,1);if(t.$parent.title=e(c,o.formatMonthTitle),t.rows=o.split(d,7),t.showWeeks){t.weekNumbers=[];for(var f=t.rows.length,m=0;m<f;m++)t.weekNumbers.push(s(t.rows[m][3].date))}},o._onDataLoaded=function(){var e,a,n=o.eventSource,r=n?n.length:0,i=o.range.startdate,l=o.range.enddate,s=t.rows,p=!1,u=[];if(s.hasEvent)for(e=0;e<6;e+=1)for(a=0;a<7;a+=1)s[e][a].hasEvent&&(s[e][a].events=null,s[e][a].hasEvent=!1);for(var c=0;c<r;c+=1){var f,m,g=n[c],v=g.startdate?new Date(g.startdate):null,h=g.enddate?new Date(g.enddate):null;if(!((h||v)<=i||(v||h)>=l)){var b,y;f=i,m=l,h||(h=v),v||(v=h),t.grouping&&!u.includes(g[t.grouping])&&u.push(g[t.grouping]),b=v<=f?0:(v-f-6e4*(v.getTimezoneOffset()-f.getTimezoneOffset()))/864e5,y=h>=m?(m-f-6e4*(m.getTimezoneOffset()-f.getTimezoneOffset()))/864e5:(h-f-6e4*(h.getTimezoneOffset()-f.getTimezoneOffset()))/864e5;for(var w,D=Math.floor(b);D<y-.001;){var $=Math.floor(D/7),_=Math.floor(D%7);s[$][_].hasEvent=!0,(w=s[$][_].events)?w.push(g):((w=[]).push(g),s[$][_].events=w),D+=1}}}for(e=0;e<6;e+=1)for(a=0;a<7;a+=1)s[e][a].hasEvent&&(p=!0,s[e][a].events.sort(d));s.hasEvent=p;var C=!1;for(e=0;e<6;e+=1){for(a=0;a<7;a+=1)if(s[e][a].selected){t.selectedDate=s[e][a],C=!0;break}if(C)break}t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=u.sort().reverse():t.categories=u.sort():t.categories=["dummy"]},o.compare=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate())-new Date(t.getFullYear(),t.getMonth(),t.getDate())},o._getRange=function(e){var t,a=e.getFullYear(),n=e.getMonth(),r=new Date(a,n,1),o=1-r.getDay(),i=o>0?7-o:-o,l=new Date(r);return i>0&&l.setDate(1-i),(t=new Date(l)).setDate(t.getDate()+42),{startdate:l,enddate:t}},o.refreshView()}}}]).directive("weekview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/week.html",require:"^calendar",link:function(t,a,n,r){function o(e,t){return e.startOffset-t.startOffset}t.formatWeekViewDayHeader=r.formatWeekViewDayHeader,t.formatHourColumn=r.formatHourColumn,r.mode={step:{days:7}},t.hourParts=r.hourParts,t.select=function(e,a){t.timeSelected&&t.timeSelected({selectedTime:e,events:a})},r._onDataLoaded=function(){var e,a,n=r.eventSource,i=n?n.length:0,l=r.range.startdate,d=r.range.enddate,s=t.rows,p=t.dates,u=!1,c=[];if(s.hasEvent){for(e=0;e<7;e+=1)for(a=0;a<24;a+=1)s[a][e].events&&(s[a][e].events=null);s.hasEvent=!1}for(e=0;e<7;e+=1)p[e].events&&(p[e].events=null);for(var f=0;f<i;f+=1){var m=n[f],g=m.startdate?new Date(m.startdate):null,v=m.enddate?new Date(m.enddate):null;if(!((v||g)<=l||(g||v)>=d)){var h,b;u=!0,v||(v=g),g||(g=v),h=g<=l?0:(g-l-6e4*(g.getTimezoneOffset()-l.getTimezoneOffset()))/36e5,b=v>=d?(d-l-6e4*(d.getTimezoneOffset()-l.getTimezoneOffset()))/36e5:(v-l-6e4*(v.getTimezoneOffset()-l.getTimezoneOffset()))/36e5;var y,w=Math.floor(h),D=Math.ceil(b-.016),$=w%24,_=Math.floor(w/24),C=24*_,k=0,x=0;1!==r.hourParts&&(k=Math.ceil((h-w)*r.hourParts));do{(C+=24)<=D?y=24:(y=D%24,1!==r.hourParts&&(x=Math.floor((D-b)*r.hourParts)));var O={event:m,startIndex:$,endIndex:y,startOffset:k,endOffset:x};t.grouping&&!c.includes(m[t.grouping])&&c.push(m[t.grouping]),s[$][_].events?s[$][_].events.push(O):s[$][_].events=[O],p[_].events?p[_].events.push(m):p[_].events=[m],$=0,k=0,_+=1}while(C<D)}}if(t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=c.sort().reverse():t.categories=c.sort():t.categories=["dummy"],u)for(e=0;e<7;e+=1){var S=[];for(a=0;a<24;a+=1)s[a][e].events&&(s[a][e].events.sort(o),S=S.concat(s[a][e].events));S.length>0&&(s.hasEvent=!0,r.placeEvents(S))}},r._refreshView=function(){var a,n,o=r.range.startdate,i=function(e,t){var a=new Array(t),n=new Date(e),r=0;for(n.setHours(12);r<t;)a[r++]={date:new Date(n)},n.setDate(n.getDate()+1);return a}(o,7);t.rows=function(e){for(var t,a,n=[],r=e.getHours(),o=e.getDate(),i=0;i<24;i+=1){t=[];for(var l=0;l<7;l+=1)(a=new Date(e.getTime())).setHours(r+i),a.setDate(o+l),t.push({date:a,events:[]});n.push(t)}return n}(o),t.dates=i,a=r.formatWeekTitle.indexOf("w"),n=e(o,r.formatWeekTitle),-1!==a&&(n=n.replace("w",function(e){var t=new Date(e);t.setDate(t.getDate()+4-(t.getDay()||7));var a=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((a-t)/864e5)/7)+1}(o))),t.$parent.title=n},r._getRange=function(e){var t=e.getFullYear(),a=e.getMonth(),n=e.getDate(),r=e.getDay();return{startdate:new Date(t,a,n-r),enddate:new Date(t,a,n-r+7)}},r.refreshView()}}}]).directive("dayview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/day.html",require:"^calendar",link:function(t,a,n,r){function o(e,t){return e.startOffset-t.startOffset}t.formatHourColumn=r.formatHourColumn,r.mode={step:{days:1}},t.hourParts=r.hourParts,t.events=[],t.select=function(e,a){t.timeSelected&&t.timeSelected({selectedTime:e,events:a})},r._onDataLoaded=function(){var e,a,n=r.eventSource,i=n?n.length:0,l=r.range.startdate,d=r.range.enddate,s=t.rows,p=!1,u=[];if(s.hasEvent){for(a=0;a<24;a+=1)s[a].events&&(s[a].events=null);s.hasEvent=!1}t.events=null;for(var c=0;c<i;c+=1){var f=n[c],m=f.startdate?new Date(f.startdate):null,g=f.enddate?new Date(f.enddate):null;if(!((g||m)<=l||(m||g)>=d)){var v,h;p=!0,g||(g=m),m||(m=g),v=m<=l?0:(m-l-6e4*(m.getTimezoneOffset()-l.getTimezoneOffset()))/36e5,h=g>=d?(d-l-6e4*(d.getTimezoneOffset()-l.getTimezoneOffset()))/36e5:(g-l-6e4*(g.getTimezoneOffset()-l.getTimezoneOffset()))/36e5;var b=Math.floor(v),y=Math.ceil(h-.016),w=0,D=0;1!==r.hourParts&&(w=Math.floor((v-b)*r.hourParts),D=Math.floor((y-h)*r.hourParts));var $={event:f,startIndex:b,endIndex:y,startOffset:w,endOffset:D};(e=s[b].events)?e.push($):((e=[]).push($),s[b].events=e),t.grouping&&!u.includes(f[t.grouping])&&u.push(f[t.grouping]),t.events?t.events.push(f):t.events=[f]}}if(p){var _=[];for(a=0;a<24;a+=1)s[a].events&&(s[a].events.sort(o),_=_.concat(s[a].events));_.length>0&&(s.hasEvent=!0,r.placeEvents(_))}t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=u.sort().reverse():t.categories=u.sort():t.categories=["dummy"]},r._refreshView=function(){var a=r.range.startdate;t.rows=function(e){for(var a,n=[],r=e.getHours(),o=e.getDate(),i=0;i<24;i+=1)(a=new Date(e.getTime())).setHours(r+i),a.setDate(o),n.push({date:a});return t.dt={date:e},n}(a),t.dates=[a],t.$parent.title=e(a,r.formatDayTitle)},r._getRange=function(e){var t=e.getFullYear(),a=e.getMonth(),n=e.getDate();return{startdate:new Date(t,a,n),enddate:new Date(t,a,n+1)}},r.refreshView()}}}]);var operationplandetailapp=angular.module("operationplandetailapp",["ngCookies","gettext","ngWebSocket","frepple.input","frepple.common","calendar"],["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1})}]);function operationplanCtrl(e,t,a,n){function r(e){if(void 0===e.color||""===e.color)return[void 0,""];var t=parseInt(e.color),a=Math.round(parseInt(e.delay)/8640)/10;return isNaN(a)&&(a=Math.round(parseInt(e.operationplan__delay)/8640)/10),999===parseInt(e.criticality)||999===parseInt(e.operationplan__criticality)?[void 0,""]:a<0?["rgba(0,128,0,0.5)",-a+" "+gettext("days early")]:0===a?["rgba(0,128,0,0.5)",gettext("on time")]:a>0?t>100||t<0?["rgba(255,0,0,0.5)",a+" "+gettext("days late")]:["rgba(255,"+Math.round(t/100*255)+",0,0.5)",a+" "+gettext("days late")]:[void 0,""]}function o(a){if(!a){var n=$("#grid").getGridParam("postData");a=n&&n.filters?JSON.parse(n.filters):initialfilter}var o=$("#grid").getGridParam("sortname"),i="";""!==o&&(i="&sidx="+encodeURIComponent(o)+"&sord="+encodeURIComponent($("#grid").getGridParam("sortorder")));var l=(-1!=location.href.indexOf("#")?location.href.substr(0,location.href.indexOf("#")):location.href)+(location.search.length>0?"&format=calendar":"?format=calendar")+"&calendarstart="+moment(e.calendarStart).format("YYYY-MM-DD%20HH:MM:SS")+"&calendarend="+moment(e.calendarEnd).format("YYYY-MM-DD%20HH:MM:SS")+i;t.get(l+"&filters="+encodeURIComponent(JSON.stringify(a))).then(function(t){var a=angular.copy(t.data);for(var n of a.rows)n.type=n.operationplan__type||n.type||default_operationplan_type,n.enddate=n.operationplan__enddate||n.enddate?new Date(n.operationplan__enddate||n.enddate):null,n.startdate=n.operationplan__startdate||n.startdate?new Date(n.operationplan__startdate||n.startdate):null,n.quantity=parseFloat(n.operationplan__quantity||n.quantity),n.hasOwnProperty("operationplan__status")&&(n.status=n.operationplan__status),n.hasOwnProperty("operationplan__origin")&&(n.origin=n.operationplan__origin),n.hasOwnProperty("operationplan__reference")&&(n.reference=n.operationplan__reference),[n.color,n.inventory_status]=r(n);e.calendarevents=a.rows,e.totalevents=a.records},function(e){console.log("Error getting calendar data")})}e.operationplan=new a,e.aggregatedopplan=null,e.mode=preferences?preferences.mode:"table",e.operationplans=[],e.kanbanoperationplans={},e.colsum=12,e.kanbancolumns=preferences?preferences.columns:void 0,e.kanbancolumns||(e.kanbancolumns=["proposed","approved","confirmed","completed","closed"]),e.groupBy=preferences?preferences.groupBy:void 0,e.groupBy||("undefined"!=typeof groupBy?e.groupBy=groupBy:e.groupBy="status"),e.groupOperator=preferences?preferences.groupOperator:void 0,e.groupOperator||(e.groupOperator="eq"),e.displayongrid=displayongrid,"function"==typeof e.displayongrid&&e.$watchGroup(["operationplan.id","operationplan.start","operationplan.end","operationplan.quantity","operationplan.status"],function(t,a){a[0]===t[0]&&-1!==t[0]&&void 0!==a[0]&&(void 0!==a[1]&&void 0!==t[1]&&a[1]!==t[1]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","startdate",a[1],new Date(e.operationplan.start)):e.displayongrid(e.operationplan.id,"startdate",e.operationplan.start)),void 0!==a[2]&&void 0!==t[2]&&a[2]!==t[2]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","enddate",a[2],new Date(e.operationplan.end)):e.displayongrid(e.operationplan.id,"enddate",e.operationplan.end)),void 0!==a[3]&&void 0!==t[3]&&a[3]!==t[3]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","quantity",a[3],e.operationplan.quantity):e.displayongrid(e.operationplan.id,"quantity",e.operationplan.quantity)),void 0!==a[4]&&void 0!==t[4]&&a[4]!==t[4]&&(actions.hasOwnProperty(e.operationplan.status)?"kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","status",a[4],e.operationplan.status):e.displayongrid(e.operationplan.id,"status",e.operationplan.status):actions[Object.keys(actions)[0]]())),a[0]=t[0]}),e.processAggregatedInfo=function(t,n){var r=[],o={colmodel:{}},i=0;angular.forEach(n,function(e,t){e.hasOwnProperty("summaryType")&&(r.push([t,e.name,e.summaryType,e.formatter]),o[e.name]=null,o.colmodel[e.name]={type:e.summaryType,label:e.label})}),angular.forEach(t,function(e){angular.forEach(r,function(t){"sum"===t[2]?isNaN(parseFloat(e[t[1]]))||(null===o[t[1]]?o[t[1]]=parseFloat(e[t[1]]):o[t[1]]+=parseFloat(e[t[1]])):"max"===t[2]?-1!==["color","number","currency"].indexOf(t[3])&&""!==e[t[1]]?parseFloat(e[t[1]])&&(null===o[t[1]]?o[t[1]]=parseFloat(e[t[1]]):o[t[1]]=Math.max(o[t[1]],parseFloat(e[t[1]]))):"duration"===t[3]?"Invalid Date"!==(i=new moment.duration(e[t[1]]).asSeconds())._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.max(o[t[1]],i)):"date"===t[3]&&"Invalid Date"!==(i=new moment(e[t[1]]))._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=moment.max(o[t[1]],i)):"min"===t[2]&&(-1!==["color","number"].indexOf(t[3])&&""!==e[t[1]]?(i=parseFloat(e[t[1]]),isNaN(i)||(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.min(o[t[1]],i))):"duration"===t[3]?"Invalid Date"!==(i=new moment.duration(e[t[1]]).asSeconds())._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.min(o[t[1]],i)):"date"===t[3]&&"Invalid Date"!==(i=new moment(e[t[1]]))._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=moment.min(o[t[1]],i)))})}),e.operationplan=new a,o.start=o.startdate,o.end=o.enddate,o.id=-1,o.count=t.length,o.type=t[0].type,e.$apply(function(){e.operationplan.extend(o)})},e.displayInfo=function(t){if("kanban"!=e.mode||void 0!==t)if(e.mode.startsWith("calendar")&&void 0===t)e.loadCalendarData();else{var n=void 0;void 0!==t&&(n=t.hasOwnProperty("operationplan__reference")?t.operationplan__reference:t.reference),e.operationplan=new a,e.operationplan.id=n,void 0===e.operationplan.id?e.$apply(function(){e.operationplan=new a}):e.operationplan.get(function(e){if(void 0===t)return e;void 0!==t.operationplan__startdate&&""!==t.operationplan__startdate?e.start=t.operationplan__startdate:void 0!==t.startdate&&""!==t.startdate&&(e.start=t.startdate),void 0!==t.operationplan__enddate&&""!==t.operationplan__enddate?e.end=t.operationplan__enddate:void 0!==t.enddate&&""!==t.enddate&&(e.end=t.enddate),void 0!==t.operationplan__quantity&&""!==t.operationplan__quantity?e.quantity=parseFloat(t.operationplan__quantity):void 0!==t.quantity&&""!==t.quantity&&(e.quantity=parseFloat(t.quantity)),void 0!==t.operationplan__status&&""!==t.operationplan__status?e.status=t.operationplan__status:void 0!==t.status&&""!==t.status&&(e.status=t.status)})}else e.loadKanbanData()},e.refreshstatus=function(t){"no_action"!==t&&e.$apply(function(){e.operationplan.status=t})},e.setMode=function(t){function a(){n.save("mode",t),e.$apply(function(){e.mode=t}),angular.element("#controller").scope().$broadcast("changeMode",t),"kanban"==t?($("#gridmode, #calendarmode").removeClass("active"),$("#kanbanmode").addClass("active"),angular.element(document).find("#customize").hide(),mode="kanban",e.loadKanbanData()):t.startsWith("calendar")?($("#kanbanmode, #gridmode").removeClass("active"),$("#calendarmode").addClass("active"),angular.element(document).find("#customize").hide(),mode=t):($("#kanbanmode, #calendarmode").removeClass("active"),$("#gridmode").addClass("active"),mode="grid",angular.element(document).find("#grid").jqGrid("GridUnload"),initialfilter=thefilter,angular.element(document).find("#customize").show(),displayGrid(!0)),setHeights()}var r=angular.element(document).find("#save");return e.mode!=t&&r.hasClass("btn-danger")?($("#popup").html('<div class="modal-dialog"><div class="modal-content"><div class="modal-header alert-warning" style="border-top-left-radius: inherit; border-top-right-radius: inherit"><h4 class="modal-title">'+gettext("Save or cancel your changes first")+'</h4></div><div class="modal-body">'+gettext("There are unsaved changes on this page.")+'</div><div class="modal-footer"><input type="submit" id="savebutton" role="button" class="btn btn-danger pull-left" value="'+gettext("Save")+'"><input type="submit" id="cancelbutton" role="button" class="btn btn-primary pull-right" value="'+gettext("Cancel")+'"></div></div></div>').modal("show"),$("#savebutton").on("click",function(){r.click(),a(),$("#popup").modal("hide")}),$("#cancelbutton").on("click",function(){$("#popup").modal("hide")}),!1):(a(),!0)},e.displayonpanel=function(t,a,n){angular.element(document).find("#"+e.operationplan.id).removeClass("edited").addClass("edited"),void 0!==e.operationplan.id&&t===e.operationplan.id.toString()&&("startdate"!==a&&"operationplan__startdate"!==a||e.$apply(function(){e.operationplan.start=n}),"enddate"!==a&&"operationplan__enddate"!==a||e.$apply(function(){e.operationplan.end=n}),"quantity"===a&&e.$apply(function(){e.operationplan.quantity=parseFloat(n)}),"status"===a&&e.refreshstatus(n))},e.calendarevents=[],e.calendarStart=null,e.calendarEnd=null,e.mode=preferences&&preferences.mode||"table",e.calendarRangeChanged=function(t,a){e.calendarStart=t,e.calendarEnd=a,e.mode&&e.mode.startsWith("calendar")&&o()},e.loadCalendarData=o,e.loadKanbanData=function(a){if(!a){var n=$("#grid").getGridParam("postData");a=n&&n.filters?JSON.parse(n.filters):initialfilter}var o=$("#grid").getGridParam("sortname"),i="";""!==o&&(i="&sidx="+encodeURIComponent(o)+"&sord="+encodeURIComponent($("#grid").getGridParam("sortorder")));var l=(-1!=location.href.indexOf("#")?location.href.substr(0,location.href.indexOf("#")):location.href)+(location.search.length>0?"&format=kanban":"?format=kanban");angular.forEach(e.kanbancolumns,function(n){var o=angular.copy(a),d={field:e.groupBy,op:e.groupOperator,data:n};void 0===o||null===o?o={groupOp:"AND",rules:[d],groups:[]}:"AND"==o.groupOp?o.rules.push(d):o={groupOp:"AND",rules:[d],groups:[o]},t.get(l+"&filters="+encodeURIComponent(JSON.stringify(o))+i).then(function(t){for(var a of(e.kanbanoperationplans[n]=angular.copy(t.data),e.kanbanoperationplans[n].rows))a.type=a.operationplan__type||a.type||default_operationplan_type,a.enddate=new Date(a.operationplan__enddate||a.enddate),a.startdate=new Date(a.operationplan__startdate||a.startdate),a.quantity=parseFloat(a.operationplan__quantity||a.quantity),a.hasOwnProperty("operationplan__status")&&(a.status=a.operationplan__status),a.hasOwnProperty("operationplan__origin")&&(a.origin=a.operationplan__origin),a.hasOwnProperty("operationplan__reference")&&(a.reference=a.operationplan__reference),[a.color,a.inventory_status]=r(a)})})},e.getDirtyCards=function(){var t=[];return e.mode&&e.mode.startsWith("calendar")?angular.forEach(e.calendarevents,function(e){var a={id:e.reference},n=!1;for(var r in e)e.hasOwnProperty(r+"Original")&&(n=!0,e[r]instanceof Date?a[r]=new moment(e[r]).format("YYYY-MM-DD hh:mm:ss"):a[r]=e[r]);n&&t.push(a)}):"kanban"==e.mode&&angular.forEach(e.kanbanoperationplans,function(e,a){angular.forEach(e.rows,function(e){var a={id:e.reference},n=!1;for(var r in e)e.hasOwnProperty(r+"Original")&&(n=!0,e[r]instanceof Date?a[r]=new moment(e[r]).format("YYYY-MM-DD hh:mm:ss"):a[r]=e[r]);n&&t.push(a)})}),t},preferences&&"kanban"==preferences.mode&&e.loadKanbanData()}function showproblemspanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("problems")+'</h4></div><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("start")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("end")+"</b></td></tr></thead><tbody></tbody></table>";e.$watchGroup(["operationplan.id","operationplan.problems.length"],function(a,n){angular.element(document).find("#attributes-operationproblems").empty().append(r);var o='<tr><td colspan="3">'+t.getString("no problems")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("problems")&&(o="",angular.forEach(e.operationplan.problems,function(e){o+="<tr><td>"+e.description+"</td><td>"+e.start+"</td><td>"+e.end+"</td></tr>"})),angular.element(document).find("#attributes-operationproblems tbody").append(o)})}}}function showresourcespanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("resource")+'</h4></div><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+"</b></td><tbody></tbody></table>";e.$watchGroup(["operationplan.id","operationplan.loadplans.length"],function a(){angular.element(document).find("#attributes-operationresources").empty().append(r);var n='<tr><td colspan="2">'+t.getString("no resources")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("loadplans")&&(n="",angular.forEach(e.operationplan.loadplans,function(e){e.hasOwnProperty("alternates")?(n+='<tr><td style="white-space: nowrap;"><div class="dropdown dropdown-submit-input"><button class="btn btn-default" data-toggle="dropdown" type="button" style="text-transform: capitalize; min-width: 150px">'+$.jgrid.htmlEncode(e.resource.name)+'</button><ul class="dropdown-menu"><li><a role="menuitem" class="alternateresource" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e.resource.name)+"</a></li>",angular.forEach(e.alternates,function(e){n+='<li><a role="menuitem" class="alternateresource" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e.name)+"</a></li>"}),n+="</ul></td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"):n+="<tr><td>"+$.jgrid.htmlEncode(e.resource.name)+'<a href="'+url_prefix+"/detail/input/resource/"+admin_escape(e.resource.name)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"}));angular.element(document).find("#attributes-operationresources tbody").append(n);angular.element(document).find("#attributes-operationresources a.alternateresource").bind("click",function(){var t=$(this).html(),n=$(this).parent().parent().prev().html();t!=n&&angular.forEach(e.operationplan.loadplans,function(r){if(r.resource.name==n){r.resource.name=t,angular.forEach(r.alternates,function(e){e.name===t&&(e.name=n)}),a();var o=angular.element(document).find("#grid"),i=o.jqGrid("getGridParam","selarrrow"),l=o.jqGrid("getGridParam","colModel").find(function(e){return"resource"==e.name}),d=o.jqGrid("getCell",i,"resource");if("detail"==l.formatter&&d==n)o.jqGrid("setCell",i,"resource",t,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1);else if("listdetail"==l.formatter){var s=[];angular.forEach(e.operationplan.loadplans,function(e){s.push([e.resource.name,e.quantity])}),o.jqGrid("setCell",i,"resource",s,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1)}return!1}})})})}}}function showbufferspanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("material")+'</h4></div><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("item")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("location")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("expected onhand")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("date")+"</b></td></tr></thead><tbody></tbody></table>";e.$watchGroup(["operationplan.id","operationplan.flowplans.length"],function a(){angular.element(document).find("#attributes-operationflowplans").empty().append(r);var n='<tr><td colspan="3">'+t.getString("no movements")+"<td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("flowplans")&&(n="",angular.forEach(e.operationplan.flowplans,function(e){n+="",e.hasOwnProperty("alternates")?(n+='<td style="white-space: nowrap;"><div class="dropdown dropdown-submit-input"><button class="btn btn-default" data-toggle="dropdown" type="button" style="text-transform: capitalize; min-width: 150px">'+$.jgrid.htmlEncode(e.buffer.item)+'</button><ul class="dropdown-menu"><li><a role="menuitem" class="alternateitem" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e.buffer.item)+"</a></li>",angular.forEach(e.alternates,function(e){n+='<li><a role="menuitem" class="alternateitem" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e)+"</a></li>"}),n+="</ul></td>"):n+="<tr><td>"+$.jgrid.htmlEncode(e.buffer.item)+'<a href="'+url_prefix+"/detail/input/item/"+admin_escape(e.buffer.item)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td>",n+="<td>"+$.jgrid.htmlEncode(e.buffer.location)+'<a href="'+url_prefix+"/detail/input/location/"+admin_escape(e.buffer.location)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td><td>"+grid.formatNumber(e.quantity)+"</td><td>"+grid.formatNumber(e.onhand)+"</td><td>"+e.date+"</td></tr>"}),angular.element(document).find("#attributes-operationflowplans thead").css("display","table-header-group"));angular.element(document).find("#attributes-operationflowplans tbody").append(n);angular.element(document).find("#attributes-operationflowplans a.alternateitem").bind("click",function(){var t=$(this).html(),n=$(this).parent().parent().prev().html();t!=n&&angular.forEach(e.operationplan.flowplans,function(r){if(r.buffer.item==n){r.buffer.item=t,a();var o=angular.element(document).find("#grid"),i=o.jqGrid("getGridParam","selarrrow"),l=o.jqGrid("getGridParam","colModel").find(function(e){return"material"==e.name}),d=o.jqGrid("getCell",i,"material");if("detail"==l.formatter&&d==n)o.jqGrid("setCell",i,"material",t,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1);else if("listdetail"==l.formatter){var s=[];angular.forEach(e.operationplan.flowplans,function(e){s.push([e.buffer.item,e.quantity])}),o.jqGrid("setCell",i,"material",s,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1)}return!1}})})})}}}function showoperationpeggingpanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n,r){var o='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("demand")+'</h4></div><div class="panel-body table-responsive" style="max-height:15em; overflow:auto; padding:0"><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("item")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("due")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+"</b></td><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.pegging_demand.length"],function(a,n){angular.element(document).find("#attributes-operationdemandpegging").empty().append(o);var r='<tr><td colspan="2">'+t.getString("no demands")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("pegging_demand")&&(r="",angular.forEach(e.operationplan.pegging_demand,function(e){r+="<tr><td>"+$.jgrid.htmlEncode(e.demand.name)+'<a href="'+url_prefix+(e.demand.forecast?"/detail/forecast/forecast/":"/detail/input/demand/")+admin_escape(e.demand.name)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td><td>"+$.jgrid.htmlEncode(e.demand.item.name)+'<a href="'+url_prefix+"/detail/input/item/"+admin_escape(e.demand.item.name)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td><td>"+e.demand.due+"</td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"})),angular.element(document).find("#attributes-operationdemandpegging tbody").append(r)})}}}function showoperationplanDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},templateUrl:"/static/operationplandetail/operationplanpanel.html",link:function(e,a,n){e.actions=actions,e.opptype={MO:t.getString("manufacturing order"),PO:t.getString("purchase order"),DO:t.getString("distribution order"),STCK:t.getString("stock"),DLVR:t.getString("delivery")},e.$on("cardChanged",function(t,a,n,r){"startdate"===a?e.operationplan.start=r:"enddate"===a?e.operationplan.end=r:e.operationplan[a]=r}),e.$watchGroup(["operationplan.id","operationplan.start","operationplan.end","operationplan.quantity","operationplan.criticality","operationplan.delay","operationplan.status"],function(t,n){void 0!==e.operationplan&&(-1==e.operationplan.id||"STCK"===e.operationplan.type?(angular.element(a).find("input").attr("disabled","disabled"),angular.element(a).find("#statusrow .btn").removeClass("active").attr("disabled","disabled")):void 0!==e.operationplan.id?(angular.element(a).find("input[disabled]").attr("disabled",!1),"undefined"!=typeof actions&&actions.hasOwnProperty("proposed")&&angular.element(a).find("button[disabled]").attr("disabled",!1),angular.element(a).find("#statusrow .btn").removeClass("active"),e.operationplan.hasOwnProperty("start")&&angular.element(a).find("#setStart").val(moment(e.operationplan.start).format("YYYY-MM-DD HH:mm:ss")),e.operationplan.hasOwnProperty("end")&&angular.element(a).find("#setEnd").val(moment(e.operationplan.end).format("YYYY-MM-DD HH:mm:ss")),e.operationplan.hasOwnProperty("status")&&(angular.element(a).find("#statusrow .btn").removeClass("active"),angular.element(a).find("#"+e.operationplan.status+"Btn").addClass("active"))):(angular.element(a).find("input").attr("disabled","disabled"),angular.element(a).find("#statusrow .btn").removeClass("active").attr("disabled","disabled"),angular.element(a).find("#setStart").val(""),angular.element(a).find("#setEnd").val("")),angular.element(a).find("#statusrow").css("display",e.operationplan.status&&"STCK"!==e.operationplan.type?"table-row":"none"))}),angular.element(a).find(".vDateField").datetimepicker({format:"YYYY-MM-DD HH:mm:ss",useCurrent:!1,calendarWeeks:!0,minDate:"2000-01-01",inline:!1,sideBySide:!0,icons:{time:"fa fa-clock-o",date:"fa fa-calendar",up:"fa fa-chevron-up",down:"fa fa-chevron-down",previous:"fa fa-chevron-left",next:"fa fa-chevron-right",today:"fa fa-bullseye",clear:"fa fa-trash",close:"fa fa-remove"},locale:language,widgetPositioning:{horizontal:"left",vertical:"bottom"}}).on("dp.change",function(t){t.oldDate&&t.date!=t.oldDate&&("setStart"===t.target.id&&e.$apply(function(){e.operationplan.start=new moment(t.date).format("YYYY-MM-DDTHH:mm:ss")}),"setEnd"===t.target.id&&e.$apply(function(){e.operationplan.end=new moment(t.date).format("YYYY-MM-DDTHH:mm:ss")}))}).on("$destroy",function(){void 0!==$(this).data("DateTimePicker")&&$(this).data("DateTimePicker").destroy()})}}}function showsupplyinformationDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("supply information")+'</h4></div><div class="table-responsive"><table class="table table-hover table-condensed"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("priority")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("types")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("origin")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("lead time")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("cost")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("size minimum")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("size multiple")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("effective start")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("effective end")+"</b></td></tr></thead><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.attributes.supply.length"],function(a,n){angular.element(document).find("#attributes-supplyinformation").empty().append(r);var o='<tr><td colspan="9">'+t.getString("no supply information")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.attributes.hasOwnProperty("supply")&&(o="",angular.forEach(e.operationplan.attributes.supply,function(e){for(var t in o+="<tr>",e)o+="<td>",o+=e[t],o+="</td>";o+="</tr>"})),angular.element(document).find("#attributes-supplyinformation tbody").append(o)})}}}function showdownstreamoperationplansDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},templateUrl:"/static/operationplandetail/downstreamoperationplans.html",link:function(e,t,a){e.expandOrCollapse=function(t){var a=t+1,n=e.operationplan.downstreamoperationplans[t][0];0==e.operationplan.downstreamoperationplans[t][10]?e.operationplan.downstreamoperationplans[t][10]=1:e.operationplan.downstreamoperationplans[t][10]=0;for(;a<e.operationplan.downstreamoperationplans.length&&!(e.operationplan.downstreamoperationplans[a][0]<=n);)e.operationplan.downstreamoperationplans[a][0]>n+1||0==e.operationplan.downstreamoperationplans[t][10]?e.operationplan.downstreamoperationplans[a][10]=2:a==e.operationplan.downstreamoperationplans.length-1||e.operationplan.downstreamoperationplans[a][0]>=e.operationplan.downstreamoperationplans[a+1][0]?e.operationplan.downstreamoperationplans[a][10]=3:e.operationplan.downstreamoperationplans[a][0]==n+1&&1==e.operationplan.downstreamoperationplans[t][10]&&(e.operationplan.downstreamoperationplans[a][10]=0),++a},e.url_prefix=url_prefix}}}function showupstreamoperationplansDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},templateUrl:"/static/operationplandetail/upstreamoperationplans.html",link:function(e,t,a){e.expandOrCollapse=function(t){var a=t+1,n=e.operationplan.upstreamoperationplans[t][0];0==e.operationplan.upstreamoperationplans[t][10]?e.operationplan.upstreamoperationplans[t][10]=1:e.operationplan.upstreamoperationplans[t][10]=0;for(;a<e.operationplan.upstreamoperationplans.length&&!(e.operationplan.upstreamoperationplans[a][0]<=n);)e.operationplan.upstreamoperationplans[a][0]>n+1||0==e.operationplan.upstreamoperationplans[t][10]?e.operationplan.upstreamoperationplans[a][10]=2:a==e.operationplan.upstreamoperationplans.length-1||e.operationplan.upstreamoperationplans[a][0]>=e.operationplan.upstreamoperationplans[a+1][0]?e.operationplan.upstreamoperationplans[a][10]=3:e.operationplan.upstreamoperationplans[a][0]==n+1&&1==e.operationplan.upstreamoperationplans[t][10]&&(e.operationplan.upstreamoperationplans[a][10]=0),++a},e.url_prefix=url_prefix}}}function showKanbanDrv(e,t,a,n){"use strict";return{restrict:"EA",scope:{operationplan:"=",kanbanoperationplans:"=",kanbancolumns:"=",editable:"="},templateUrl:"/static/operationplandetail/kanban.html",link:function(e,a,r){function o(){switch(e.kanbancolumns.length){case 1:e.colstyle="col-md-12",e.colsum=12;break;case 2:e.colstyle="col-md-6",e.colsum=12;break;case 3:e.colstyle="col-md-4",e.colsum=12;break;case 4:e.colstyle="col-md-3",e.colsum=12;break;case 5:e.colstyle="col-md-3",e.colsum=15;break;case 6:e.colstyle="col-md-2",e.colsum=12;break;case 7:e.colstyle="col-md-2",e.colsum=14;break;case 8:e.colstyle="col-md-2",e.colsum=16;break;default:e.colstyle="col-md-1",e.colsum=e.kanbancolumns.length}e.$parent.colsum=e.colsum}function i(e){e.preventDefault()}function l(t){var a=$(t.target).closest(".column").attr("data-column");if(a){var r=t.originalEvent.dataTransfer.getData("startcolumn"),o=t.originalEvent.dataTransfer.getData("startindex");if("undefined"!==o){var i=$(t.target).closest(".card");i&&(i=i.attr("data-index")),e.$apply(function(){var t=e.kanbanoperationplans[r].rows[o];e.kanbanoperationplans[r].rows.splice(o,1),i?e.kanbanoperationplans[a].rows.splice(i>o&&a==r?i-1:i,0,t):e.kanbanoperationplans[a].rows.unshift(t),e.kanbanoperationplans[r].records--,e.kanbanoperationplans[a].records++,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),t.hasOwnProperty("statusOriginal")?(t.statusOriginal==a?(t.dirty=!1,delete t.statusOriginal):t.dirty=!0,t.status=a):t.status!=a&&(t.statusOriginal=t.status,t.status=a,t.dirty=!0),e.$parent.$broadcast("cardChanged","status",t.statusOriginal,t.status)})}else e.$apply(function(){var t=e.kanbancolumns.indexOf(r),o=e.kanbancolumns.indexOf(a),i=e.kanbancolumns[t];e.kanbancolumns[t]=e.kanbancolumns[o],e.kanbancolumns[o]=i,n.save("columns",e.$parent.kanbancolumns)})}t.preventDefault()}function d(e){e.originalEvent.dataTransfer.setData("startindex",$(e.target).attr("data-index")),e.originalEvent.dataTransfer.setData("startcolumn",$(e.target).closest(".column").attr("data-column"))}function s(){a.on("dragover",".column, .card",i),a.on("drop",".column",l),a.on("dragstart",".column .panel .panel-heading, .card",d)}function p(){a.off("dragover",".column, .card",i),a.off("drop",".column",l),a.off("dragstart",".column .panel .panel-heading, .card",d)}e.curselected=null,e.colstyle="col-md-1",e.colsum=12,e.type="PO",e.admin_escape=admin_escape,e.url_prefix=url_prefix,e.mode=mode,e.opptype={MO:t.getString("Manufacturing Order"),PO:t.getString("Purchase Order"),DO:t.getString("Distribution Order"),STCK:t.getString("Stock"),DLVR:t.getString("Delivery")},o(),e.getHeight=function(e){return preferences&&preferences.height?preferences.height-(e||25):220},e.hideColumn=function(t){var a=e.$parent.kanbancolumns.indexOf(t);e.$parent.kanbancolumns.splice(a,1),o(),n.save("columns",e.$parent.kanbancolumns)},e.grid=grid,e.selectCard=function(t){if(e.curselected){if(e.curselected.reference==t.reference&&t.selected)return;delete e.curselected.selected}t.selected=!0,e.curselected=t,e.$parent.displayInfo(t)},e.$on("selectedEdited",function(t,a,n,r){if(null!==e.curselected){if(e.changeCard(e.curselected,a,n),"status"===a){var o=e.kanbanoperationplans[n].rows.indexOf(e.curselected);-1!=o&&(e.kanbanoperationplans[n].rows.splice(o,1),e.kanbanoperationplans[r].rows.unshift(e.curselected),e.kanbanoperationplans[n].records--,e.kanbanoperationplans[r].records++)}e.curselected[a]=r}}),e.changeCard=function(t,a,n,r){t.hasOwnProperty(a+"Original")||(t[a+"Original"]=n),t.dirty=!0,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),void 0!==r&&e.$parent.$broadcast("cardChanged",a,n,r)},e.enableDragDrop=s,e.disableDragDrop=p,e.$on("changeMode",function(t,a){e.mode=a,"kanban"==a?s():p()}),"kanban"==mode&&s()}}}operationplandetailapp.config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",e.defaults.xsrfCookieName="csrftoken",e.defaults.xsrfHeaderName="X-CSRFToken"}]),operationplandetailapp.run(["gettextCatalog",function(e){e.setCurrentLanguage(language)}]),operationplandetailapp.filter("formatdate",function(){return function(e){if(void 0!==e)return moment(Date.parse(e)).format("YYYY-MM-DD HH:mm:ss")}}),angular.module("operationplandetailapp").controller("operationplandetailCtrl",operationplanCtrl),operationplanCtrl.$inject=["$scope","$http","OperationPlan","PreferenceSvc"],angular.module("operationplandetailapp").directive("showproblemspanelDrv",showproblemspanelDrv),showproblemspanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showresourcespanelDrv",showresourcespanelDrv),showresourcespanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showbufferspanelDrv",showbufferspanelDrv),showbufferspanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showoperationpeggingpanelDrv",showoperationpeggingpanelDrv),showoperationpeggingpanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showoperationplanDrv",showoperationplanDrv),showoperationplanDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showsupplyinformationDrv",showsupplyinformationDrv),showsupplyinformationDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showdownstreamoperationplansDrv",showdownstreamoperationplansDrv),showdownstreamoperationplansDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showupstreamoperationplansDrv",showupstreamoperationplansDrv),showupstreamoperationplansDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showKanbanDrv",showKanbanDrv),showKanbanDrv.$inject=["$window","gettextCatalog","OperationPlan","PreferenceSvc"];
//# sourceMappingURL=frepple-operationplandetail.min.js.map